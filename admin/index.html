<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ù†ÙˆØ§Øª</title>
<style>
body{font-family:tahoma;background:#111;color:#fff;margin:0;padding:20px}
h1{text-align:center}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #444;padding:8px;text-align:center}
th{background:#222}
input,button{padding:6px;border-radius:5px;border:0;width:100%}
button{cursor:pointer}
.add{background:#28a745;color:#fff;margin-bottom:10px}
.save{background:#007bff;color:#fff;margin-top:15px}
.del{background:#dc3545;color:#fff}
</style>
</head>
<body>

<h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h1>

<button class="add" onclick="addRow()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</button>

<table>
<thead>
<tr>
<th>ID</th>
<th>Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</th>
<th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
<th>Ø§Ù„Ø±Ø§Ø¨Ø·</th>
<th>User-Agent</th>
<th>Referer</th>
<th>Origin</th>
<th>Ø§Ù„Ù‡ÙŠØ¯Ø±Ø²</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button class="save" onclick="save()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>

<script>
let channels = {};

async function load(){
  const r = await fetch('/api/channels');
  channels = await r.json();
  render();
}

function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = '';
  Object.keys(channels).forEach(pack=>{
    channels[pack].forEach(ch=>{
      tbody.innerHTML += row(ch,pack);
    });
  });
}

function row(ch, pack) {
  const hasHeaders =
    ch.headers &&
    (ch.headers['user-agent'] || ch.headers.referer || ch.headers.origin);

  const status = hasHeaders
    ? '<span style="color:#28a745;font-weight:bold">âœ” Ù…ÙˆØ¬ÙˆØ¯</span>'
    : '<span style="color:#dc3545;font-weight:bold">âœ– Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';

  const bgColor = hasHeaders ? '#1a3d1a' : '#3d1a1a'; // Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚ Ø£Ùˆ Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚

  return `<tr style="background:${bgColor}">
  <td><input value="${ch.id || ''}"></td>
  <td><input value="${ch.name || ''}"></td>
  <td><input value="${pack || ''}"></td>
  <td><input value="${ch.url || ''}"></td>
  <td><input value="${ch.headers?.['user-agent'] || ''}"></td>
  <td><input value="${ch.headers?.referer || ''}"></td>
  <td><input value="${ch.headers?.origin || ''}"></td>
  <td>${status}</td>
  <td><button class="del" onclick="this.parentElement.parentElement.remove()">âŒ</button></td>
  </tr>`;
}

function addRow(){
  document.getElementById("tbody").innerHTML += row({},'');
}

async function save(){
  const rows = document.querySelectorAll("#tbody tr");
  let data = {};

  rows.forEach(r=>{
    const t = r.querySelectorAll("input");

    const id   = t[0].value.trim();
    const name = t[1].value.trim();
    const pack = t[2].value.trim() || "General";
    const url  = t[3].value.trim();

    const ua  = t[4].value.trim();
    const ref = t[5].value.trim();
    const ori = t[6].value.trim();

    if(!id || !name || !url) return;

    if(!data[pack]) data[pack] = [];

    data[pack].push({
      id,
      name,
      url,
      category: pack,
      headers: {
        "user-agent": ua,
        "referer": ref,
        "origin": ori
      }
    });
  });

  const res = await fetch('/api/save',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data, null, 2)
  });

  if(res.ok){
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø¨Ù†Ø¬Ø§Ø­");
  }else{
    alert("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
  }
}

load();
</script>

</body>
</html>
