<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Super IPTV</title>
<style>
body{font-family:tahoma;background:#0f172a;color:#fff;margin:0;padding:0}
header{background:#020617;padding:15px;text-align:center;font-size:22px;font-weight:bold}
.container{padding:20px;max-width:1200px;margin:auto}
input,select,button{padding:10px;border-radius:6px;border:0;font-size:14px}
button{cursor:pointer;background:#22c55e;color:#000;font-weight:bold}
button.red{background:#ef4444;color:#fff}
button.blue{background:#3b82f6;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #1e293b;text-align:center}
th{background:#020617}
tr:hover{background:#020617}
.form{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}
.search{margin-bottom:10px;width:100%}
@media(max-width:900px){
.form{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Super IPTV</header>

<div class="container">

<div class="form">
<input id="id" placeholder="ID">
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©">
<input id="url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«">
<input id="group" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©">

<input id="ua" placeholder="User-Agent">
<input id="ref" placeholder="Referer">
<input id="org" placeholder="Origin">

<button onclick="addChannel()">â• Ø¥Ø¶Ø§ÙØ©</button>
<button onclick="updateChannel()" class="blue">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
</div>

<input class="search" id="search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="render()">

<table>
<thead>
<tr>
<th>ID</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
<th>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</th>
<th>Ø§Ù„ØªØ­ÙƒÙ…</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

</div>

<script>
let channels = {};
let editId = null;

async function load(){
  const r = await fetch('/api/channels.js'); // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª
  channels = await r.json();
  render();
  loadViewers();
}

function render(){
  const q = search.value.toLowerCase();
  list.innerHTML='';

  for(const group in channels){
    channels[group].forEach(ch=>{
      if(
        ch.name.toLowerCase().includes(q) ||
        ch.id.includes(q)
      ){
        list.innerHTML+=`
        <tr>
          <td>${ch.id}</td>
          <td>${ch.name}</td>
          <td>${group}</td>
          <td id="viewers-${ch.id}">0</td>
          <td>
            <button onclick='edit("${group}","${ch.id}")' class="blue">âœï¸</button>
            <button onclick='del("${group}","${ch.id}")' class="red">ğŸ—‘</button>
          </td>
        </tr>
        `;
      }
    })
  }
}

function addChannel(){
  const g = group.value.trim();
  if(!channels[g]) channels[g]=[];

  channels[g].push({
    id:id.value.trim(),
    name:name.value.trim(),
    url:url.value.trim(),
    headers:{
      "User-Agent": ua.value.trim(),
      "Referer": ref.value.trim(),
      "Origin": org.value.trim()
    }
  });

  save();
}

function edit(groupName,idVal){
  const ch = channels[groupName].find(x=>x.id==idVal);
  id.value=ch.id;
  name.value=ch.name;
  url.value=ch.url;
  group.value=groupName;
  ua.value=ch.headers?.["User-Agent"] || "";
  ref.value=ch.headers?.["Referer"] || "";
  org.value=ch.headers?.["Origin"] || "";
  editId=idVal;
}

function updateChannel(){
  if(!editId) return alert("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹");

  const g = group.value.trim();

  for(const k in channels){
    channels[k]=channels[k].filter(x=>x.id!=editId);
  }

  if(!channels[g]) channels[g]=[];

  channels[g].push({
    id:id.value.trim(),
    name:name.value.trim(),
    url:url.value.trim(),
    headers:{
      "User-Agent": ua.value.trim(),
      "Referer": ref.value.trim(),
      "Origin": org.value.trim()
    }
  });

  editId=null;
  save();
}

function del(groupName,idVal){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø©ØŸ")) return;
  channels[groupName]=channels[groupName].filter(x=>x.id!=idVal);
  save();
}

async function save(){
  await fetch('/api/save.js', {      // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(channels)
  });
  // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
  id.value = name.value = url.value = group.value = ua.value = ref.value = org.value = "";
  load();
}

// ================== Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ù„Ø­Ø¸ÙŠ ==================
async function loadViewers(){
  try{
    for(const group in channels){
      for(const ch of channels[group]){
        const res = await fetch(`/api/viewers?id=${ch.id}`);
        const data = await res.json();
        const count = data[ch.id] || 0;
        const el = document.getElementById(`viewers-${ch.id}`);
        if(el) el.innerText = count;
      }
    }
  }catch(e){
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:", e.message);
  }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
setInterval(loadViewers, 1000);

  load();

</script>

</body>
</html>
